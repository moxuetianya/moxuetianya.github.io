<!doctype html>
<html class="not-ready lg:text-base overflow-y-scroll scroll-pt-14" lang="en">

<head prefix="og: https://ogp.me/ns# article: https://ogp.me/ns/article#">
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="generator" content="Zola" />
  <title>wireshark插件 解析自定义协议</title>
  <meta property="og:title" content="wireshark插件 解析自定义协议" />
  <meta property="og:url" content="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/" />
  <link rel="canonical" href="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/" />
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2025-07-30T16:34:38+08:00" />
  <meta property="article:tag" content="protocol" />
  <meta property="article:tag" content="协议" />
  <!-- Begin Head inject -->
  
  <!-- End Head inject -->
  <link rel="stylesheet" href="https://blog.moxuetianya.com/main.min.css?h=fc65ba308cf36d3ba82c" />
  <style>
  :root{--bg: #f4f4f5; --header: #e4e4e7; color-scheme: light;}
  :root.dark{--bg: #18181b; --header: #27272a; color-scheme: dark;}
  </style>
  <meta name="theme-color" data-light="#e4e4e7" data-dark="#27272a" content="#e4e4e7" />
  <link rel="icon" type="image/x-icon" sizes="16x16" href="https://blog.moxuetianya.com/favicon.ico" />
  <link rel="apple-touch-icon" type="image/png" href="https://blog.moxuetianya.com/apple-touch-icon.png?h=58bee300054c5308feb3" />
  <link rel="icon" type="image/png" href="https://blog.moxuetianya.com/android-icon.png?h=8d80ec95446bd2c36826" />
  <script src="https://blog.moxuetianya.com/js/linkita.min.js?h=1dd3ed42fc674277bc34"></script>
  <script src="https://blog.moxuetianya.com/js/linkita-search.min.js?h=698547b4b081d012c661"></script>
  <!-- Begin Head End inject -->
  
  <!-- End Head End inject -->
</head>

<body class="text-black duration-100 ease-out bg-[var(--bg)] dark:text-white">
  <!-- Header -->
<header class="bg-[var(--header)] fixed top-0 z-40 mx-auto min-h-[3.25rem] w-full header-icons">
  <div class="mx-auto w-full max-w-4xl p-2.5 lg:flex lg:justify-between">
    <div class="flex justify-between">
      <div class="flex items-center min-h-8">
        <button type="button" title="Go to home page" accesskey="!"
          onclick="window.location.href='https://blog.moxuetianya.com/';"
          class="btn-home h-6 w-6 shrink-0 cursor-pointer text-[0] bg-center bg-no-repeat bg-cover [background-image:var(--icon-home)] dark:invert"
        ></button>
        <button type="button" title="Switch color scheme" accesskey="$"
          onclick="window.linkita.toggleDarkMode();" ondblclick="window.linkita.resetDarkMode();"
          class="btn-dark ml-4 h-6 w-6 shrink-0 cursor-pointer text-[0] bg-center bg-no-repeat bg-cover dark:invert [background-image:var(--icon-theme-dark)] dark:[background-image:var(--icon-theme-light)]"
        ></button>
        <button type="button" title="Search" accesskey="/"
          onclick="window.linkita.toggleSearch();"
          class="btn-search ml-4 h-6 w-6 shrink-0 cursor-pointer text-[0] bg-center bg-no-repeat bg-cover [background-image:var(--icon-search)] dark:invert"
        ></button>
        <script>window.linkita.initSearchButton({ scripts: ["https://blog.moxuetianya.com/elasticlunr.min.js", "https://blog.moxuetianya.com/search_index.en.js"] });</script>
      </div>
    </div>
  </div>
</header>

  <!-- Begin Body Start inject -->
  
  <!-- End Body Start inject -->
  <main class="prose prose-neutral relative mx-auto min-h-[calc(100%-4rem)]
    max-w-3xl break-words px-4 pb-12 pt-28 lg:pt-32 dark:prose-invert prose-pre:rounded-lg prose-img:rounded-lg">
      <!-- Search -->
<div id="linkita-search-wrapper" class="hidden">
  <ul id="linkita-search-results"></ul>
</div>

    
<article>
  <!-- Begin Page Start inject -->
  
  <!-- End Page Start inject -->

  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">wireshark插件 解析自定义协议</h1>
    <!-- Page Info -->
<div class="text-sm antialiased opacity-80"><time
      datetime="2025-07-30T16:34:38+08:00">2025-07-30</time><span
        class="mx-1">&middot;</span><time
    datetime="PT0H6M0S">6&nbsp;min</time>
</div>

  </header>
  <!-- TOC -->
<div class="block-bg mb-12 rounded-lg p-2 text-lg">
  <details>
    <summary class="select-none py-0.5 lg:py-1 pl-4" accesskey="=">
      <span class="cursor-pointer">Table of Contents</span>
    </summary>
    <div class="px-2">
      <ul>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/#ji-chu">基础</a>
          <ul>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/#protofield">ProtoField</a>
            </li>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/#tvb">tvb</a>
            </li>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/#pinfo">pinfo</a>
            </li>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/#treeitem">TreeItem</a>
            </li>
          </ul>
        </li>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/#jiao-ben-mo-ban">脚本模板</a>
        </li>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/#pei-zhi-luajiao-ben">配置lua脚本</a>
          <ul>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/#xin-ban-ben-wireshark4-2-zhong-de-wei-zhi-you-suo-gai-bian">新版本wireshark4.2 中的位置有所改变</a>
            </li>
          </ul>
        </li>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/#gao-ji-yi-dian-de-wan-fa">高级一点的玩法</a>
        </li>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/07/wireshark插件 解析自定义协议/#can-kao">参考</a>
        </li>
      </ul>
    </div>
  </details>
</div>

  <!-- Content -->
  <section><p>Wireshark内置了Lua脚本编写插件，无需配置额外的环境，使用起来吧比较便。</p>
<p>使用Lua编写Wireshark协议解析插件，有几个比较重要的概念:</p>
<ol>
<li>Dissector,解剖器，用来解析包的类，我们要编写的，也是一个Dissector。</li>
<li>DissectorTable,解析器表是Wireshark中解析器的组织形式，是某一种协议的子解析器的一个列表，其作用是把所有的解析器组织成一种树状结构，便于Wireshark在解析包的时候自动选择对应的解析器。例如TCP协议的子解析器 http, smtp, sip等都被加在了"tcp.port"这个解析器表中，可以根据抓到的包的不同的tcp端口号，自动选择对应的解析器。</li>
</ol>
<h1 id="ji-chu">基础</h1>
<p><img src="https://blog.moxuetianya.com/2025/07/wireshark%E6%8F%92%E4%BB%B6%20%E8%A7%A3%E6%9E%90%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE/2025-07-30-17-28-53.png" alt="主要接口" /></p>
<pre data-lang="lua" style="background-color:#2b303b;color:#c0c5ce;" class="language-lua "><code class="language-lua" data-lang="lua"><span style="color:#65737e;">-- create a new protocol
</span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">proto_name </span><span>= &quot;</span><span style="color:#a3be8c;">PNASKCP</span><span>&quot;
</span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">proto_desc </span><span>= &quot;</span><span style="color:#a3be8c;">Private NAS Protocol (KCP)</span><span>&quot;
</span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">proto_obj </span><span>= </span><span style="color:#bf616a;">Proto</span><span>(</span><span style="color:#bf616a;">proto_name</span><span>, </span><span style="color:#bf616a;">proto_desc</span><span>)
</span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">proto_port </span><span>= </span><span style="color:#d08770;">5067
</span><span>
</span><span style="color:#65737e;">--register this dissector add Packet Details
</span><span style="color:#bf616a;">DissectorTable</span><span>.</span><span style="color:#bf616a;">get</span><span>(&quot;</span><span style="color:#a3be8c;">udp.port</span><span>&quot;):</span><span style="color:#bf616a;">add</span><span>(</span><span style="color:#bf616a;">proto_port</span><span>, </span><span style="color:#bf616a;">proto_obj</span><span>)
</span></code></pre>
<h2 id="protofield">ProtoField</h2>
<p>表示协议字段，一般用于解析字段后往解析树上添加节点。根据字段类型不同，其接口可以分为两大类。
这些接口都会返回一个新的字段对象。方括号内是可选字段，花括号内是可替换的类型字段。</p>
<pre data-lang="text" style="background-color:#2b303b;color:#c0c5ce;" class="language-text "><code class="language-text" data-lang="text"><span>ProtoField.{type}(abbr, [name], [base], [valuestring], [mask], [desc])
</span><span>·type包括:uint8, uint16, uint24, uint32, uint64, framenum, float, double, string, stringz, bytes, bool, ipv4, ipv6, ether,oid, guid
</span></code></pre>
<p>参数</p>
<ul>
<li>abbr 字段的缩写名称（过滤器中使用的字符串）。</li>
<li>name (optional) 字段的实际名称（出现在树中的字符串）。</li>
<li>base (optional) base.DEC，base.HEX或base.OCT，base.DEC_HEX，base.HEX_DEC，base.UNIT_STRING或base.RANGE_STRING。</li>
<li>valuestring (optional) 包含与值对应的文本的表，或包含与值 ({min, max, “string”}) 对应的范围字符串值表的表（如果基数为 ）base.RANGE_STRING，或包含单位名称的表如果 base 是base.UNIT_STRING.</li>
<li>mask (optional) 此字段的整数掩码。</li>
<li>desc (optional) 字段说明。</li>
</ul>
<pre data-lang="lua" style="background-color:#2b303b;color:#c0c5ce;" class="language-lua "><code class="language-lua" data-lang="lua"><span style="color:#bf616a;">fields</span><span>.tlv_value_int16 = </span><span style="color:#bf616a;">ProtoField</span><span>.</span><span style="color:#bf616a;">uint16</span><span>(</span><span style="color:#bf616a;">proto_name </span><span>.. &quot;</span><span style="color:#a3be8c;">.tlv_value_int</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">PNAS TLV VALUE</span><span>&quot;, </span><span style="color:#bf616a;">base</span><span>.HEX)
</span><span style="color:#bf616a;">fields</span><span>.uri_ipv4 = </span><span style="color:#bf616a;">ProtoField</span><span>.</span><span style="color:#bf616a;">ipv4</span><span>(</span><span style="color:#bf616a;">proto_name </span><span>.. &quot;</span><span style="color:#a3be8c;">.uri_ipv4</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">IP ADDRESS</span><span>&quot;)
</span></code></pre>
<h2 id="tvb">tvb</h2>
<p>Tvb（Testy Virtual Buffer）表示报文缓存，也就是实际的报文数据，可以通过下面介绍的TvbRange从报文数据中解出信息。主要接口有：
<img src="https://blog.moxuetianya.com/2025/07/wireshark%E6%8F%92%E4%BB%B6%20%E8%A7%A3%E6%9E%90%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE/2025-07-30-17-31-38.png" alt="tvb 接口" /></p>
<pre data-lang="lua" style="background-color:#2b303b;color:#c0c5ce;" class="language-lua "><code class="language-lua" data-lang="lua"><span style="color:#65737e;">-- tvb(offset, 4)表示从offset开始之后的4个字节
</span><span style="color:#bf616a;">subtree</span><span>:</span><span style="color:#bf616a;">add_le</span><span>(</span><span style="color:#bf616a;">fields</span><span>.peer_ipaddr, </span><span style="color:#bf616a;">tvb</span><span>(</span><span style="color:#bf616a;">offset</span><span>, </span><span style="color:#d08770;">4</span><span>))
</span></code></pre>
<h2 id="pinfo">pinfo</h2>
<p>报文信息(packet information)。主要接口有：
<img src="https://blog.moxuetianya.com/2025/07/wireshark%E6%8F%92%E4%BB%B6%20%E8%A7%A3%E6%9E%90%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE/2025-07-30-17-32-48.png" alt="" /></p>
<pre data-lang="lua" style="background-color:#2b303b;color:#c0c5ce;" class="language-lua "><code class="language-lua" data-lang="lua"><span style="color:#65737e;">-- show protocol name
</span><span style="color:#bf616a;">pinfo</span><span>.cols.protocol = &quot;</span><span style="color:#a3be8c;">PNASKCP</span><span>&quot;
</span><span style="color:#65737e;">-- show in info
</span><span style="color:#bf616a;">pinfo</span><span>.cols.info:</span><span style="color:#bf616a;">set</span><span>(&quot;</span><span style="color:#a3be8c;">Private NAS Protocol (CALL_REQUEST)</span><span>&quot;) 
</span></code></pre>
<h2 id="treeitem">TreeItem</h2>
<p>表示报文解析树中的一个树节点。主要接口有：
<img src="https://blog.moxuetianya.com/2025/07/wireshark%E6%8F%92%E4%BB%B6%20%E8%A7%A3%E6%9E%90%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE/2025-07-30-17-33-31.png" alt="" />
还有注意一下网络字节序的问题，如果是网络字节序需要用add_le添加节点</p>
<pre data-lang="lua" style="background-color:#2b303b;color:#c0c5ce;" class="language-lua "><code class="language-lua" data-lang="lua"><span style="color:#65737e;">-- kcp header
</span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">subtree </span><span>= </span><span style="color:#bf616a;">tree</span><span>:</span><span style="color:#bf616a;">add</span><span>(</span><span style="color:#bf616a;">proto_obj</span><span>, </span><span style="color:#bf616a;">tvb</span><span>(</span><span style="color:#bf616a;">offset</span><span>, </span><span style="color:#bf616a;">lmmh_len</span><span>), &quot;</span><span style="color:#a3be8c;">KCP</span><span>&quot;)	
</span><span style="color:#65737e;">--conv
</span><span style="color:#bf616a;">subtree</span><span>:</span><span style="color:#bf616a;">add_le</span><span>(</span><span style="color:#bf616a;">fields</span><span>.conv, </span><span style="color:#bf616a;">tvb</span><span>(</span><span style="color:#bf616a;">offset</span><span>, </span><span style="color:#d08770;">4</span><span>))
</span><span style="color:#bf616a;">offset </span><span>= </span><span style="color:#bf616a;">offset </span><span>+ </span><span style="color:#d08770;">4
</span><span style="color:#65737e;">--cmd
</span><span style="color:#bf616a;">subtree</span><span>:</span><span style="color:#bf616a;">add_le</span><span>(</span><span style="color:#bf616a;">fields</span><span>.cmd, </span><span style="color:#bf616a;">tvb</span><span>(</span><span style="color:#bf616a;">offset</span><span>, </span><span style="color:#d08770;">1</span><span>))
</span><span style="color:#bf616a;">offset </span><span>= </span><span style="color:#bf616a;">offset </span><span>+ </span><span style="color:#d08770;">1
</span><span style="color:#65737e;">--frg
</span><span style="color:#bf616a;">subtree</span><span>:</span><span style="color:#bf616a;">add_le</span><span>(</span><span style="color:#bf616a;">fields</span><span>.frg, </span><span style="color:#bf616a;">tvb</span><span>(</span><span style="color:#bf616a;">offset</span><span>, </span><span style="color:#d08770;">1</span><span>))
</span><span style="color:#bf616a;">offset </span><span>= </span><span style="color:#bf616a;">offset </span><span>+ </span><span style="color:#d08770;">1
</span><span style="color:#65737e;">--wnd
</span><span style="color:#bf616a;">subtree</span><span>:</span><span style="color:#bf616a;">add_le</span><span>(</span><span style="color:#bf616a;">fields</span><span>.wnd, </span><span style="color:#bf616a;">tvb</span><span>(</span><span style="color:#bf616a;">offset</span><span>, </span><span style="color:#d08770;">2</span><span>))
</span><span style="color:#bf616a;">offset </span><span>= </span><span style="color:#bf616a;">offset </span><span>+ </span><span style="color:#d08770;">2
</span></code></pre>
<h1 id="jiao-ben-mo-ban">脚本模板</h1>
<p>创建编译 packet-demo.lua 文件</p>
<pre data-lang="lua" style="background-color:#2b303b;color:#c0c5ce;" class="language-lua "><code class="language-lua" data-lang="lua"><span style="color:#b48ead;">do
</span><span>
</span><span style="color:#65737e;">-- 创建一个新的协议: 协议名称为 fuzz_proto，在Packet Details窗格显示为 Fuzz Custom Protocol
</span><span style="color:#bf616a;">fuzz_protocol </span><span>= </span><span style="color:#bf616a;">Proto</span><span>(&quot;</span><span style="color:#a3be8c;">fuzz_proto</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Fuzz Custom Protocol</span><span>&quot;)
</span><span>
</span><span style="color:#65737e;">-- 定义协议字段
</span><span style="color:#65737e;">--[[ 自定义字段
</span><span style="color:#65737e;">protocol_type(2) -- 自定义协议编号
</span><span style="color:#65737e;">base_protocol(1) -- 下层协议
</span><span style="color:#65737e;">connection_index(1) -- 收发状态
</span><span style="color:#65737e;">round_index(4) -- 本轮次序号
</span><span style="color:#65737e;">--]]
</span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">f_protocol_type </span><span>= </span><span style="color:#bf616a;">ProtoField</span><span>.</span><span style="color:#bf616a;">uint16</span><span>(&quot;</span><span style="color:#a3be8c;">fuzz_proto.protocol_type</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Custom Protocol ID</span><span>&quot;, </span><span style="color:#bf616a;">base</span><span>.DEC)
</span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">f_base_protocol </span><span>= </span><span style="color:#bf616a;">ProtoField</span><span>.</span><span style="color:#bf616a;">uint8</span><span>(&quot;</span><span style="color:#a3be8c;">fuzz_proto.base_protocol</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Base Protocol</span><span>&quot;, </span><span style="color:#bf616a;">base</span><span>.DEC)
</span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">f_connection_index </span><span>= </span><span style="color:#bf616a;">ProtoField</span><span>.</span><span style="color:#bf616a;">uint8</span><span>(&quot;</span><span style="color:#a3be8c;">fuzz_proto.connection_index</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Connection ID</span><span>&quot;, </span><span style="color:#bf616a;">base</span><span>.DEC)
</span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">f_round_index </span><span>= </span><span style="color:#bf616a;">ProtoField</span><span>.</span><span style="color:#bf616a;">uint32</span><span>(&quot;</span><span style="color:#a3be8c;">fuzz_proto.round_index</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Round Index</span><span>&quot;, </span><span style="color:#bf616a;">base</span><span>.DEC)
</span><span style="color:#65737e;">-- 将字段添加到协议中
</span><span style="color:#bf616a;">fuzz_protocol</span><span>.fields = { </span><span style="color:#bf616a;">f_protocol_type</span><span>, </span><span style="color:#bf616a;">f_base_protocol</span><span>, </span><span style="color:#bf616a;">f_connection_index</span><span>, </span><span style="color:#bf616a;">f_round_index </span><span>} 
</span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">data_dis </span><span>= </span><span style="color:#bf616a;">Dissector</span><span>.</span><span style="color:#bf616a;">get</span><span>(&quot;</span><span style="color:#a3be8c;">data</span><span>&quot;)
</span><span>
</span><span style="color:#65737e;">-- 定义协议的解析函数
</span><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">FUZZ_dissector</span><span>(buffer, pinfo, tree)
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">length </span><span>= </span><span style="color:#bf616a;">buffer</span><span>:</span><span style="color:#bf616a;">len</span><span>()
</span><span>    </span><span style="color:#65737e;">-- 确保报文有足够的长度供解析
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">length </span><span>&lt; </span><span style="color:#d08770;">8 </span><span style="color:#b48ead;">then
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">false
</span><span>    </span><span style="color:#b48ead;">end
</span><span>    </span><span style="color:#65737e;">--验证一下identifier这个字段是不是0x12,如果不是的话，认为不是我要解析的packet
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">v_identifier </span><span>= </span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">0</span><span>, </span><span style="color:#d08770;">1</span><span>)
</span><span>    </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">v_identifier</span><span>:</span><span style="color:#bf616a;">uint</span><span>() ~= </span><span style="color:#d08770;">0x12</span><span>) </span><span style="color:#b48ead;">then 
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">false 
</span><span>    </span><span style="color:#b48ead;">end
</span><span>    </span><span style="color:#65737e;">--取出其他字段的值
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">v_length </span><span>= </span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">1</span><span>)
</span><span>    </span><span style="color:#bf616a;">v_length </span><span>= </span><span style="color:#96b5b4;">tonumber</span><span>(</span><span style="color:#96b5b4;">tostring</span><span>(</span><span style="color:#bf616a;">v_length</span><span>),</span><span style="color:#d08770;">16</span><span>)
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">v_data </span><span>= </span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">2</span><span>,</span><span style="color:#bf616a;">v_length</span><span>)
</span><span>
</span><span>    </span><span style="color:#65737e;">-- 显示协议名称 --在主窗口的 Protocol 字段显示的名称为 XX_Protobuf
</span><span>    </span><span style="color:#65737e;">-- pinfo.cols.protocol:set(&quot;XX_Protobuf&quot;)
</span><span>    </span><span style="color:#bf616a;">pinfo</span><span>.cols.protocol = &quot;</span><span style="color:#a3be8c;">fuzz_proto</span><span>&quot;
</span><span>
</span><span>    </span><span style="color:#65737e;">--现在知道是我的协议了，放心大胆添加Packet Details
</span><span>    </span><span style="color:#65737e;">-- 在树形结构中添加Headers
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">subtree </span><span>= </span><span style="color:#bf616a;">tree</span><span>:</span><span style="color:#bf616a;">add</span><span>(</span><span style="color:#bf616a;">fuzz_protocol</span><span>, </span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">0</span><span>, </span><span style="color:#d08770;">7</span><span>), &quot;</span><span style="color:#a3be8c;">Fuzz Header</span><span>&quot;)
</span><span>    </span><span style="color:#65737e;">-- 解析协议字段并添加到树中
</span><span>    </span><span style="color:#bf616a;">subtree</span><span>:</span><span style="color:#bf616a;">add</span><span>(</span><span style="color:#bf616a;">f_protocol_type</span><span>, </span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">0</span><span>, </span><span style="color:#d08770;">2</span><span>))
</span><span>
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">d_base_protocol </span><span>= </span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">2</span><span>, </span><span style="color:#d08770;">1</span><span>):</span><span style="color:#bf616a;">uint</span><span>()
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">d_base_protocol_map </span><span>= {
</span><span>        [</span><span style="color:#d08770;">0</span><span>] = &quot;</span><span style="color:#a3be8c;">UnSet</span><span>&quot;,
</span><span>        [</span><span style="color:#d08770;">1</span><span>] = &quot;</span><span style="color:#a3be8c;">Ethernet</span><span>&quot;,
</span><span>        [</span><span style="color:#d08770;">2</span><span>] = &quot;</span><span style="color:#a3be8c;">IP</span><span>&quot;,
</span><span>        [</span><span style="color:#d08770;">3</span><span>] = &quot;</span><span style="color:#a3be8c;">TCP</span><span>&quot;,
</span><span>        [</span><span style="color:#d08770;">4</span><span>] = &quot;</span><span style="color:#a3be8c;">UDP</span><span>&quot;,
</span><span>        [</span><span style="color:#d08770;">5</span><span>] = &quot;</span><span style="color:#a3be8c;">TLS</span><span>&quot;,
</span><span>        [</span><span style="color:#d08770;">6</span><span>] = &quot;</span><span style="color:#a3be8c;">HTTP</span><span>&quot;
</span><span>    }
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">d_base_protocol </span><span>= </span><span style="color:#bf616a;">d_base_protocol_map</span><span>[</span><span style="color:#bf616a;">d_base_protocol</span><span>] or &quot;</span><span style="color:#a3be8c;">Unknown</span><span>&quot;
</span><span>    </span><span style="color:#bf616a;">subtree</span><span>:</span><span style="color:#bf616a;">add</span><span>(</span><span style="color:#bf616a;">f_base_protocol</span><span>, </span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">2</span><span>, </span><span style="color:#d08770;">1</span><span>)):</span><span style="color:#bf616a;">append_text</span><span>(&quot;</span><span style="color:#a3be8c;"> (</span><span>&quot; .. </span><span style="color:#bf616a;">d_base_protocol </span><span>.. &quot;</span><span style="color:#a3be8c;">)</span><span>&quot;)
</span><span>
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">d_connection_index </span><span>= (</span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">3</span><span>, </span><span style="color:#d08770;">1</span><span>):</span><span style="color:#bf616a;">uint</span><span>() &lt; </span><span style="color:#d08770;">127</span><span>) and &quot;</span><span style="color:#a3be8c;">Send</span><span>&quot; or &quot;</span><span style="color:#a3be8c;">Receive</span><span>&quot;
</span><span>    </span><span style="color:#bf616a;">subtree</span><span>:</span><span style="color:#bf616a;">add</span><span>(</span><span style="color:#bf616a;">f_connection_index</span><span>, </span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">3</span><span>, </span><span style="color:#d08770;">1</span><span>)):</span><span style="color:#bf616a;">append_text</span><span>(&quot;</span><span style="color:#a3be8c;"> (</span><span>&quot; .. </span><span style="color:#bf616a;">d_connection_index </span><span>.. &quot;</span><span style="color:#a3be8c;">)</span><span>&quot;)
</span><span>
</span><span>    </span><span style="color:#65737e;">-- 本轮次序号, 取值为十六进制，需要将其转换为十进制 
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">d_round_index </span><span>= string.</span><span style="color:#96b5b4;">format</span><span>(&quot;</span><span style="color:#a3be8c;">%d</span><span>&quot;, </span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">4</span><span>, </span><span style="color:#d08770;">4</span><span>):</span><span style="color:#bf616a;">uint</span><span>()) 
</span><span>    </span><span style="color:#bf616a;">subtree</span><span>:</span><span style="color:#bf616a;">add</span><span>(</span><span style="color:#bf616a;">f_round_index</span><span>, </span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">4</span><span>, </span><span style="color:#d08770;">4</span><span>)):</span><span style="color:#bf616a;">append_text</span><span>(&quot;</span><span style="color:#a3be8c;"> (</span><span>&quot; .. </span><span style="color:#bf616a;">d_round_index </span><span>.. &quot;</span><span style="color:#a3be8c;">)</span><span>&quot;) 
</span><span>
</span><span>    </span><span style="color:#65737e;">-- 解析下层协议
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">payload </span><span>= </span><span style="color:#bf616a;">buffer</span><span>(</span><span style="color:#d08770;">8</span><span>, </span><span style="color:#bf616a;">length </span><span>- </span><span style="color:#d08770;">8</span><span>)
</span><span>    </span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">subtree_payload </span><span>= </span><span style="color:#bf616a;">tree</span><span>:</span><span style="color:#bf616a;">add</span><span>(</span><span style="color:#bf616a;">fuzz_protocol</span><span>, </span><span style="color:#bf616a;">payload</span><span>, &quot;</span><span style="color:#a3be8c;">Current Custom Protocol</span><span>&quot;)
</span><span>    </span><span style="color:#bf616a;">subtree_payload</span><span>:</span><span style="color:#bf616a;">add</span><span>(&quot;</span><span style="color:#a3be8c;">Payload</span><span>&quot;, </span><span style="color:#bf616a;">payload</span><span>):</span><span style="color:#bf616a;">append_text</span><span>(&quot;</span><span style="color:#a3be8c;"> (</span><span>&quot; .. </span><span style="color:#bf616a;">payload</span><span>:</span><span style="color:#bf616a;">len</span><span>() .. &quot;</span><span style="color:#a3be8c;"> bytes)</span><span>&quot;)
</span><span style="color:#b48ead;">end
</span><span>
</span><span style="color:#b48ead;">function </span><span style="color:#bf616a;">fuzz_protocol</span><span>.</span><span style="color:#8fa1b3;">dissector</span><span>(buffer, pinfo, tree)
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">FUZZ_dissector</span><span>(</span><span style="color:#bf616a;">buffer</span><span>, </span><span style="color:#bf616a;">pinfo</span><span>, </span><span style="color:#bf616a;">tree</span><span>) </span><span style="color:#b48ead;">then
</span><span>        </span><span style="color:#65737e;">-- valid Fuzz diagram
</span><span>    </span><span style="color:#b48ead;">else
</span><span>        </span><span style="color:#65737e;">-- data这个dissector几乎是必不可少的；当发现不是我的协议时，就应该调用data
</span><span>        </span><span style="color:#bf616a;">data_dis</span><span>.</span><span style="color:#bf616a;">call</span><span>(</span><span style="color:#bf616a;">buffer</span><span>, </span><span style="color:#bf616a;">pinfo</span><span>, </span><span style="color:#bf616a;">tree</span><span>)
</span><span>    </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span><span>
</span><span style="color:#65737e;">-- 注册 dissector 到对应的 DLT_USER3 (150)
</span><span style="color:#65737e;">-- local wtap_encap_table = DissectorTable.get(&quot;wtap_encap&quot;)
</span><span style="color:#65737e;">-- wtap_encap_table:add(150, fuzz_protocol)
</span><span style="color:#b48ead;">local </span><span style="color:#bf616a;">tcp_encap_table </span><span>= </span><span style="color:#bf616a;">DissectorTable</span><span>.</span><span style="color:#bf616a;">get</span><span>(&quot;</span><span style="color:#a3be8c;">tcp.port</span><span>&quot;)
</span><span style="color:#65737e;">--因为我们的自定义协议的接受端口是1080，所以这里只需要添加到&quot;tcp.port&quot;这个DissectorTable里即可。
</span><span style="color:#bf616a;">tcp_encap_table</span><span>:</span><span style="color:#bf616a;">add</span><span>(</span><span style="color:#d08770;">1080</span><span>, </span><span style="color:#bf616a;">fuzz_protocol</span><span>)
</span><span style="color:#b48ead;">end
</span><span>
</span></code></pre>
<h1 id="pei-zhi-luajiao-ben">配置lua脚本</h1>
<p><img src="https://blog.moxuetianya.com/2025/07/wireshark%E6%8F%92%E4%BB%B6%20%E8%A7%A3%E6%9E%90%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE/2025-07-30-17-11-07.png" alt="lua脚本位置" /></p>
<p>如图， 在/usr/share/wireshark/init.lua文件中，添加：</p>
<pre data-lang="lua" style="background-color:#2b303b;color:#c0c5ce;" class="language-lua "><code class="language-lua" data-lang="lua"><span style="color:#bf616a;">enable_lua </span><span>= </span><span style="color:#d08770;">true
</span><span style="color:#96b5b4;">dofile</span><span>(&quot;</span><span style="color:#a3be8c;">/home/peter/.config/wireshark/packet-demo.lua</span><span>&quot;)
</span></code></pre>
<p>然后重新启动Wireshark或者点击【分析】-【重新载入Lua插件】，就可以启用你自己的lua插件了。</p>
<h2 id="xin-ban-ben-wireshark4-2-zhong-de-wei-zhi-you-suo-gai-bian">新版本wireshark4.2 中的位置有所改变</h2>
<p><img src="https://blog.moxuetianya.com/2025/07/wireshark%E6%8F%92%E4%BB%B6%20%E8%A7%A3%E6%9E%90%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE/2025-08-13-18-58-36.png" alt="" />
如图 init.lua需要 放置在 /usr/lib/x86_64-linux-gnu/wireshark/plugins/init.lua 位置
并添加</p>
<pre data-lang="lua" style="background-color:#2b303b;color:#c0c5ce;" class="language-lua "><code class="language-lua" data-lang="lua"><span style="color:#96b5b4;">dofile</span><span>(</span><span style="color:#bf616a;">DATA_DIR</span><span>..&quot;</span><span style="color:#a3be8c;">/packet-demo.lua</span><span>&quot;)
</span></code></pre>
<h1 id="gao-ji-yi-dian-de-wan-fa">高级一点的玩法</h1>
<p>如果我们协议的PayLoad里封装的其实是以太网包，能不能让Wireshark在我们的插件执行完之后，继续按照以太网格式解析其他部分呢？</p>
<p>这里，我们重新构造一下需要继续解析的数据，然后获取出一个以太网解析器就继续做下去</p>
<pre data-lang="lua" style="background-color:#2b303b;color:#c0c5ce;" class="language-lua "><code class="language-lua" data-lang="lua"><span style="color:#b48ead;">local </span><span style="color:#bf616a;">raw_data </span><span>= </span><span style="color:#bf616a;">buf</span><span>(</span><span style="color:#d08770;">8</span><span>, </span><span style="color:#bf616a;">buf</span><span>:</span><span style="color:#bf616a;">len</span><span>() - </span><span style="color:#d08770;">8</span><span>)
</span><span style="color:#bf616a;">Dissector</span><span>.</span><span style="color:#bf616a;">get</span><span>(&quot;</span><span style="color:#a3be8c;">eth_maybefcs</span><span>&quot;):</span><span style="color:#bf616a;">call</span><span>(</span><span style="color:#bf616a;">raw_data</span><span>:</span><span style="color:#bf616a;">tvb</span><span>(), </span><span style="color:#bf616a;">pinfo</span><span>, </span><span style="color:#bf616a;">tree</span><span>)
</span></code></pre>
<p>替换上面代码的-- 解析下层协议即可
需要在注意,</p>
<ol>
<li>获取的解析器名称应该是 eth_maybefcs，因为DissectorTable里写的eth，但是提示找不到。 eth_maybefcs，意思是可能带有fcs的eth帧</li>
<li>raw_data需要调用一下tvb()函数，不然会提示你这个是userdata，不能使用。tvb的全称应该是Testy Virtual Buffer，用来存储Packet buffer的，要处理必须先转成这个。</li>
</ol>
<p>调用eth_maybefcs解析器的时候，这些解析器会给协议栏赋值，覆盖掉我们之前写的wfuzz protocol。为了区分，我们可以在上面的代码之后加上：</p>
<pre data-lang="lua" style="background-color:#2b303b;color:#c0c5ce;" class="language-lua "><code class="language-lua" data-lang="lua"><span style="color:#bf616a;">pkt</span><span>.cols.protocol:</span><span style="color:#bf616a;">append</span><span>(&quot;</span><span style="color:#a3be8c;">-FuzzProtocol</span><span>&quot;)
</span></code></pre>
<p>就是不管协议栏被改成了什么，都在后面加上-FuzzProtocol，这样ARP、ICMP等就会变成 ARP-Fuzz、ICMP-Fuzz了，一眼就可以跟那些普通的ARP和ICMP区分出来。</p>
<h1 id="can-kao">参考</h1>
<p><a href="https://www.cnblogs.com/little-kwy/p/14888454.html">wireshark插件开发</a></br>
<a href="https://zhuanlan.zhihu.com/p/568748288">自定义协议</a></br>
<a href="https://zhuanlan.zhihu.com/p/5968603110">wireshark lua api 协议解析</a></br></p>
</section>
  <hr />
  <!-- Post Taxonomies -->
<footer class="mt-12 flex flex-col" tabindex="-1" accesskey="_">
  <div class="mb-2 flex flex-wrap">
    <span class="block-bg mb-1.5 mr-1.5 rounded-lg px-5 py-1.5">Tags</span>
    
    <a
      class="block-bg block-hover mb-1.5 mr-1.5 rounded-lg px-5 py-1.5 no-underline"
      href="https://blog.moxuetianya.com/tags/protocol/">protocol</a>
    
    <a
      class="block-bg block-hover mb-1.5 mr-1.5 rounded-lg px-5 py-1.5 no-underline"
      href="https://blog.moxuetianya.com/tags/xie-yi/">协议</a>
    
  </div>
</footer>

  <!-- Post Nav -->
<nav class="block-bg mt-12 flex flex-wrap rounded-lg text-lg">
  <a
    class="block-hover-mask flex min-w-[50%] grow items-center rounded-l-md p-6 pr-3 font-semibold no-underline"
    href="https://blog.moxuetianya.com/2025/08/输入法工作原理ibus/" accesskey=","
    ><span class="mr-1.5">&#8249;</span><span>输入法工作原理ibus</span></a>
  <a
    class="block-hover-mask ml-auto flex min-w-[50%] grow items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline"
    href="https://blog.moxuetianya.com/2025/07/手动安装vscode server/" accesskey="."
    ><span>手动安装vscode server</span><span class="ml-1.5">&#8250;</span></a>
</nav>

  <!-- Begin Page End inject -->
  
  <!-- End Page End inject -->
</article>

  </main>
  <!-- Footer -->
<footer class="mx-auto flex lg:mt-5 max-w-3xl flex-wrap items-center px-4 py-3 text-sm opacity-60">
  <div class="mr-auto basis-full lg:basis-1/2">
  © <time datetime="2025">2025</time> moxuetianya
  </div>
  <div class="flex basis-full lg:basis-1/2 lg:justify-end">
    <span class="mr-6 lg:ml-6">
      <a class="link" href="https://www.getzola.org/" target="_blank">Powered by Zola</a>
    </span>
    <a class="link" href="https://www.getzola.org/themes/linkita/" target="_blank">&#9998; Linkita</a>
  </div>
  <!-- Begin Footer inject -->
  
  <!-- End Footer inject -->
</footer>

  

  <!-- Begin Body End inject -->
  
  <!-- End Body End inject -->
</body>

</html>
