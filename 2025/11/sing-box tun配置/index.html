<!doctype html>
<html class="not-ready lg:text-base overflow-y-scroll scroll-pt-14" lang="en">

<head prefix="og: https://ogp.me/ns# article: https://ogp.me/ns/article#">
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="generator" content="Zola" />
  <title>sing-box tun配置</title>
  <meta property="og:title" content="sing-box tun配置" />
  <meta property="og:url" content="https://blog.moxuetianya.com/2025/11/sing-box tun配置/" />
  <link rel="canonical" href="https://blog.moxuetianya.com/2025/11/sing-box tun配置/" />
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2025-11-23T19:57:28+08:00" />
  <meta property="article:tag" content="tun" />
  <!-- Begin Head inject -->
  
  <!-- End Head inject -->
  <link rel="stylesheet" href="https://blog.moxuetianya.com/main.min.css?h=fc65ba308cf36d3ba82c" />
  <style>
  :root{--bg: #f4f4f5; --header: #e4e4e7; color-scheme: light;}
  :root.dark{--bg: #18181b; --header: #27272a; color-scheme: dark;}
  </style>
  <meta name="theme-color" data-light="#e4e4e7" data-dark="#27272a" content="#e4e4e7" />
  <link rel="icon" type="image/x-icon" sizes="16x16" href="https://blog.moxuetianya.com/favicon.ico" />
  <link rel="apple-touch-icon" type="image/png" href="https://blog.moxuetianya.com/apple-touch-icon.png?h=58bee300054c5308feb3" />
  <link rel="icon" type="image/png" href="https://blog.moxuetianya.com/android-icon.png?h=8d80ec95446bd2c36826" />
  <script src="https://blog.moxuetianya.com/js/linkita.min.js?h=1dd3ed42fc674277bc34"></script>
  <script src="https://blog.moxuetianya.com/js/linkita-search.min.js?h=698547b4b081d012c661"></script>
  <!-- Begin Head End inject -->
  
  <!-- End Head End inject -->
</head>

<body class="text-black duration-100 ease-out bg-[var(--bg)] dark:text-white">
  <!-- Header -->
<header class="bg-[var(--header)] fixed top-0 z-40 mx-auto min-h-[3.25rem] w-full header-icons">
  <div class="mx-auto w-full max-w-4xl p-2.5 lg:flex lg:justify-between">
    <div class="flex justify-between">
      <div class="flex items-center min-h-8">
        <button type="button" title="Go to home page" accesskey="!"
          onclick="window.location.href='https://blog.moxuetianya.com/';"
          class="btn-home h-6 w-6 shrink-0 cursor-pointer text-[0] bg-center bg-no-repeat bg-cover [background-image:var(--icon-home)] dark:invert"
        ></button>
        <button type="button" title="Switch color scheme" accesskey="$"
          onclick="window.linkita.toggleDarkMode();" ondblclick="window.linkita.resetDarkMode();"
          class="btn-dark ml-4 h-6 w-6 shrink-0 cursor-pointer text-[0] bg-center bg-no-repeat bg-cover dark:invert [background-image:var(--icon-theme-dark)] dark:[background-image:var(--icon-theme-light)]"
        ></button>
        <button type="button" title="Search" accesskey="/"
          onclick="window.linkita.toggleSearch();"
          class="btn-search ml-4 h-6 w-6 shrink-0 cursor-pointer text-[0] bg-center bg-no-repeat bg-cover [background-image:var(--icon-search)] dark:invert"
        ></button>
        <script>window.linkita.initSearchButton({ scripts: ["https://blog.moxuetianya.com/elasticlunr.min.js", "https://blog.moxuetianya.com/search_index.en.js"] });</script>
      </div>
    </div>
  </div>
</header>

  <!-- Begin Body Start inject -->
  
  <!-- End Body Start inject -->
  <main class="prose prose-neutral relative mx-auto min-h-[calc(100%-4rem)]
    max-w-3xl break-words px-4 pb-12 pt-28 lg:pt-32 dark:prose-invert prose-pre:rounded-lg prose-img:rounded-lg">
      <!-- Search -->
<div id="linkita-search-wrapper" class="hidden">
  <ul id="linkita-search-results"></ul>
</div>

    
<article>
  <!-- Begin Page Start inject -->
  
  <!-- End Page Start inject -->

  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">sing-box tun配置</h1>
    <!-- Page Info -->
<div class="text-sm antialiased opacity-80"><time
      datetime="2025-11-23T19:57:28+08:00">2025-11-23</time><span
        class="mx-1">&middot;</span><time
    datetime="PT0H5M0S">5&nbsp;min</time>
</div>

  </header>
  <!-- TOC -->
<div class="block-bg mb-12 rounded-lg p-2 text-lg">
  <details>
    <summary class="select-none py-0.5 lg:py-1 pl-4" accesskey="=">
      <span class="cursor-pointer">Table of Contents</span>
    </summary>
    <div class="px-2">
      <ul>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/sing-box tun配置/#sing-box-pei-zhi-tunde-yuan-li">sing-box 配置tun的原理</a>
        </li>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/sing-box tun配置/#chuang-jian-lu-you-ming-cheng-bing-shi-lu-you-sheng-xiao">创建路由名称 并使路由生效</a>
        </li>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/sing-box tun配置/#fwmark">fwmark</a>
        </li>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/sing-box tun配置/#shi-yong-ip-rule-pei-zhi-lu-you-gui-ze">使用 ip rule 配置路由规则</a>
          <ul>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/sing-box tun配置/#tian-jia-lu-you-gui-ze-de-ip-rule-yong-fa-ru-xia">添加路由规则的 ip rule 用法如下：</a>
            </li>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/sing-box tun配置/#ip-rule-you-xian-ji">ip rule 优先级</a>
            </li>
          </ul>
        </li>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/sing-box tun配置/#diao-shi">调试</a>
        </li>
      </ul>
    </div>
  </details>
</div>

  <!-- Content -->
  <section><h1 id="sing-box-pei-zhi-tunde-yuan-li">sing-box 配置tun的原理</h1>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#65737e;"># Routing Policy DataBase
</span><span style="color:#bf616a;">sudo</span><span> ip rule add priority 9000 from all to 172.20.0.0/30 table 2022  
</span><span style="color:#bf616a;">sudo</span><span> ip rule add priority 9003 not iif lo lookup 2022
</span><span style="color:#65737e;"># 9003: not from all iif lo lookup 2022  # 生成的结果中自动添加了from all
</span><span>
</span><span style="color:#bf616a;">ip</span><span> rule
</span><span>
</span><span style="color:#bf616a;">0:</span><span>    from all lookup local
</span><span style="color:#bf616a;">9000:</span><span> from all to 172.20.0.0/30 lookup 2022
</span><span style="color:#65737e;"># 不匹配路由前缀为0（不匹配缺省路由）
</span><span style="color:#bf616a;">9001:</span><span> from all lookup 2022 suppress_prefixlength 0
</span><span style="color:#65737e;"># 地址非53端口的所有流量
</span><span style="color:#bf616a;">9002:</span><span> not from all dport 53 lookup main suppress_prefixlength 0
</span><span style="color:#bf616a;">9002:</span><span> from all ipproto icmp goto 9010
</span><span style="color:#bf616a;">9002:</span><span> from all iif tun0 goto 9010
</span><span style="color:#bf616a;">9003:</span><span> not from all iif lo lookup 2022
</span><span style="color:#bf616a;">9003:</span><span> from 0.0.0.0 iif lo lookup 2022
</span><span style="color:#bf616a;">9003:</span><span> from 172.20.0.0/30 iif lo lookup 2022
</span><span style="color:#bf616a;">9010:</span><span> from all nop
</span><span style="color:#bf616a;">32766:</span><span> from all lookup main
</span><span style="color:#bf616a;">32767:</span><span> from all lookup default
</span></code></pre>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">ip</span><span> route show table 2022
</span><span style="color:#bf616a;">default</span><span> dev tun0
</span><span>
</span><span style="color:#bf616a;">ip</span><span> route show table main
</span><span style="color:#bf616a;">default</span><span> via 11.11.11.1 dev pppoe-wan proto static
</span><span style="color:#bf616a;">11.11.11.1</span><span> dev pppoe-wan proto kernel scope link src 11.11.11.5
</span><span style="color:#bf616a;">192.168.11.0/24</span><span> dev br-lan proto kernel scope link src 192.168.11.1
</span></code></pre>
<h1 id="chuang-jian-lu-you-ming-cheng-bing-shi-lu-you-sheng-xiao">创建路由名称 并使路由生效</h1>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#96b5b4;">echo</span><span> 100 custom &gt;&gt; /etc/iproute2/rt_tables 
</span><span style="color:#bf616a;">ip</span><span> route add default via 192.168.1.100 dev eth1 table custom
</span><span style="color:#bf616a;">ip</span><span> rule add to 192.168.1.200 lookup custom
</span></code></pre>
<h1 id="fwmark">fwmark</h1>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">iptables -t</span><span> mangle</span><span style="color:#bf616a;"> -A</span><span> FORWARD</span><span style="color:#bf616a;"> -i</span><span> eth3</span><span style="color:#bf616a;"> -p</span><span> tcp</span><span style="color:#bf616a;"> --dport</span><span> 80</span><span style="color:#bf616a;"> -j</span><span> MARK</span><span style="color:#bf616a;"> --set-mark</span><span> 1  
</span><span style="color:#bf616a;">iptables -t</span><span> mangle</span><span style="color:#bf616a;"> -A</span><span> FORWARD</span><span style="color:#bf616a;"> -i</span><span> eth3</span><span style="color:#bf616a;"> -p</span><span> tcp</span><span style="color:#bf616a;"> --dport</span><span> 25</span><span style="color:#bf616a;"> -j</span><span> MARK</span><span style="color:#bf616a;"> --set-mark</span><span> 2  
</span><span style="color:#bf616a;">iptables -t</span><span> mangle</span><span style="color:#bf616a;"> -A</span><span> FORWARD</span><span style="color:#bf616a;"> -i</span><span> eth3</span><span style="color:#bf616a;"> -p</span><span> tcp</span><span style="color:#bf616a;"> --dport</span><span> 110</span><span style="color:#bf616a;"> -j</span><span> MARK</span><span style="color:#bf616a;"> --set-mark</span><span> 2  
</span><span style="color:#bf616a;">iptables -t</span><span> mangle</span><span style="color:#bf616a;"> -A</span><span> FORWARD</span><span style="color:#bf616a;"> -i</span><span> eth3</span><span style="color:#bf616a;"> -j</span><span> MARK</span><span style="color:#bf616a;"> --set-mark</span><span> 3  
</span><span style="color:#bf616a;">ip</span><span> rule add fwmark 1 table 1  
</span><span style="color:#bf616a;">ip</span><span> rule add fwmark 2 table 2  
</span><span style="color:#bf616a;">ip</span><span> rule add fwmark 3 table 3
</span></code></pre>
<h1 id="shi-yong-ip-rule-pei-zhi-lu-you-gui-ze">使用 ip rule 配置路由规则</h1>
<p>内核需要根据规则，来为数据包选择要进行的操作或选择使用的路由表——当数据包能够匹配某些规则，则对该数据包执行该规则所对应的动作，比如查找一个路由表。Linux 的默认规则会让入向和出向的流量都 "lookup" 默认路由表。</p>
<h2 id="tian-jia-lu-you-gui-ze-de-ip-rule-yong-fa-ru-xia">添加路由规则的 ip rule 用法如下：</h2>
<ul>
<li>
<p>ip rule add {prefix} {selector} {predicate}</p>
</li>
<li>
<p>ip rule add 的意思很好理解，就是使用其后的参数，添加一个新的规则。prefix 表示该规则的应用范围——是入向流量还是出向流量。selector 表示需要使用的过滤条件。predicate 的意思是谓语，表示 selector 的对象或要执行的动作。</p>
<ul>
<li>prefix: from {addr} | to {addr}</li>
<li>selector: to {addr} | priority &lt;#&gt; | fwmark <fwmark> | iif <name> | oif <name> | tos <value></li>
<li>predicate: {blackhole | prohibited | unreachable} | lookup <table id></li>
</ul>
</li>
<li>
<p>prefix 是源地址和/或目的地址，可以是单一 IP 地址或一个地址段。from 后接源地址/地址范围，to 后接目的地址/地址范围。也可以用 all 表示所有地址。这里的 from 和 to 会被用来对数据包进行匹配，能够匹配上的则会被应用该条规则；</p>
</li>
<li>
<p>selector 可以对数据包进行进一步的过滤，同一条规则中可以使用多个 selector。常用的 selector 有下面几种：</p>
<ul>
<li>fwmark：数据包的标记值，在命令中填的 10 进制数字会被转成 16 进制存储和使用，如果要使用 16 进制表示，则需要在前面加个 x。需要注意的是，fwmark（FireWall MARK）只能由 iptables 添加；</li>
<li>iif：入向接口名称；</li>
<li>oif：出向接口名称；</li>
<li>priority：本条规则的优先级，数字越小，优先级越高。该值必须是唯一的，即，不允许出现两条优先级相同的路由规则；</li>
<li>tos：Type of Service，服务类型；</li>
<li>ipproto：ip 层协议类型；</li>
<li>sport、dport：源端口及目的端口，可以是特定端口或端口范围</li>
</ul>
</li>
<li>
<p>predicate 表示当本条规则匹配成功时要执行的动作，包括：</p>
<ul>
<li>lookup：查找要使用的路由表；</li>
<li>unreachable：设置该路由不可达，数据包会被丢弃，ICMP 会返回 host unreachable，发送代码会报错 EHOSTUNREACH ；</li>
<li>blackhole（黑洞）：数据包会被无声丢弃（discarded silently），发送代码会报错 EINVAL ；</li>
<li>prohabit（禁止）：数据包会被丢弃并给一个报错。ICMP 会返回 communication administratively prohibited。发送代码会报错 EACCES；</li>
<li>需要注意的是，ip rule 并不能对数据包添加标记，而只能检查 fwmark 值，并根据该值确定如何处理数据包</li>
</ul>
</li>
</ul>
<h2 id="ip-rule-you-xian-ji">ip rule 优先级</h2>
<p>这里的优先级指的是使用 ip rule 的 priority 选项设置的优先级。这个优先级实际上是最后才会发挥作用的——只有当多条规则的其他部分（from / to，过滤规则等）都完全相同时，系统才会根据该值选择真正要使用的规则。</p>
<p>如果用命令设置规则的时候没有指定优先级，则系统会自动为该规则添加一个比【最近使用的规则的优先级高一级】的优先级值。比如最近用的一条路由规则的优先级为 100 ，则新添加的一条规则的优先级值就是 99。</p>
<h1 id="diao-shi">调试</h1>
<ul>
<li>用 TRACE 调试路由</li>
<li>开启 debug：</li>
</ul>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#96b5b4;">echo</span><span> 65535 &gt; /proc/sys/net/ipv4/rt_trace_max_size
</span><span style="color:#bf616a;">sysctl -w</span><span> net.core.netdev_max_backlog=5000
</span><span>
</span><span style="color:#bf616a;">rtmon</span><span> rt filter
</span><span style="color:#65737e;"># 可以看到 RPDB 的逐条匹配过程。
</span></code></pre>
</section>
  <hr />
  <!-- Post Taxonomies -->
<footer class="mt-12 flex flex-col" tabindex="-1" accesskey="_">
  <div class="mb-2 flex flex-wrap">
    <span class="block-bg mb-1.5 mr-1.5 rounded-lg px-5 py-1.5">Tags</span>
    
    <a
      class="block-bg block-hover mb-1.5 mr-1.5 rounded-lg px-5 py-1.5 no-underline"
      href="https://blog.moxuetianya.com/tags/tun/">tun</a>
    
  </div>
</footer>

  <!-- Post Nav -->
<nav class="block-bg mt-12 flex flex-wrap rounded-lg text-lg">
  <a
    class="block-hover-mask flex min-w-[50%] grow items-center rounded-l-md p-6 pr-3 font-semibold no-underline"
    href="https://blog.moxuetianya.com/2025/11/systemd-nspawn lxc podman 容器对比/" accesskey=","
    ><span class="mr-1.5">&#8249;</span><span>systemd-nspawn lxc podman 容器对比</span></a>
  <a
    class="block-hover-mask ml-auto flex min-w-[50%] grow items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline"
    href="https://blog.moxuetianya.com/2025/11/linux wifi网卡不工作/" accesskey="."
    ><span>linux wifi网卡不工作</span><span class="ml-1.5">&#8250;</span></a>
</nav>

  <!-- Begin Page End inject -->
  
  <!-- End Page End inject -->
</article>

  </main>
  <!-- Footer -->
<footer class="mx-auto flex lg:mt-5 max-w-3xl flex-wrap items-center px-4 py-3 text-sm opacity-60">
  <div class="mr-auto basis-full lg:basis-1/2">
  © <time datetime="2025">2025</time> moxuetianya
  </div>
  <div class="flex basis-full lg:basis-1/2 lg:justify-end">
    <span class="mr-6 lg:ml-6">
      <a class="link" href="https://www.getzola.org/" target="_blank">Powered by Zola</a>
    </span>
    <a class="link" href="https://www.getzola.org/themes/linkita/" target="_blank">&#9998; Linkita</a>
  </div>
  <!-- Begin Footer inject -->
  
  <!-- End Footer inject -->
</footer>

  

  <!-- Begin Body End inject -->
  
  <!-- End Body End inject -->
</body>

</html>
