<!doctype html>
<html class="not-ready lg:text-base overflow-y-scroll scroll-pt-14" lang="en">

<head prefix="og: https://ogp.me/ns# article: https://ogp.me/ns/article#">
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="generator" content="Zola" />
  <title>uefi 安装启动</title>
  <meta property="og:title" content="uefi 安装启动" />
  <meta property="og:url" content="https://blog.moxuetianya.com/2025/11/uefi 安装启动/" />
  <link rel="canonical" href="https://blog.moxuetianya.com/2025/11/uefi 安装启动/" />
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2025-11-28T17:37:06+08:00" />
  <meta property="article:tag" content="uefi" />
  <meta property="article:tag" content="secure boot" />
  <!-- Begin Head inject -->
  
  <!-- End Head inject -->
  <link rel="stylesheet" href="https://blog.moxuetianya.com/main.min.css?h=fc65ba308cf36d3ba82c" />
  <style>
  :root{--bg: #f4f4f5; --header: #e4e4e7; color-scheme: light;}
  :root.dark{--bg: #18181b; --header: #27272a; color-scheme: dark;}
  </style>
  <meta name="theme-color" data-light="#e4e4e7" data-dark="#27272a" content="#e4e4e7" />
  <link rel="icon" type="image/x-icon" sizes="16x16" href="https://blog.moxuetianya.com/favicon.ico" />
  <link rel="apple-touch-icon" type="image/png" href="https://blog.moxuetianya.com/apple-touch-icon.png?h=58bee300054c5308feb3" />
  <link rel="icon" type="image/png" href="https://blog.moxuetianya.com/android-icon.png?h=8d80ec95446bd2c36826" />
  <script src="https://blog.moxuetianya.com/js/linkita.min.js?h=1dd3ed42fc674277bc34"></script>
  <script src="https://blog.moxuetianya.com/js/linkita-search.min.js?h=698547b4b081d012c661"></script>
  <!-- Begin Head End inject -->
  
  <!-- End Head End inject -->
</head>

<body class="text-black duration-100 ease-out bg-[var(--bg)] dark:text-white">
  <!-- Header -->
<header class="bg-[var(--header)] fixed top-0 z-40 mx-auto min-h-[3.25rem] w-full header-icons">
  <div class="mx-auto w-full max-w-4xl p-2.5 lg:flex lg:justify-between">
    <div class="flex justify-between">
      <div class="flex items-center min-h-8">
        <button type="button" title="Go to home page" accesskey="!"
          onclick="window.location.href='https://blog.moxuetianya.com/';"
          class="btn-home h-6 w-6 shrink-0 cursor-pointer text-[0] bg-center bg-no-repeat bg-cover [background-image:var(--icon-home)] dark:invert"
        ></button>
        <button type="button" title="Switch color scheme" accesskey="$"
          onclick="window.linkita.toggleDarkMode();" ondblclick="window.linkita.resetDarkMode();"
          class="btn-dark ml-4 h-6 w-6 shrink-0 cursor-pointer text-[0] bg-center bg-no-repeat bg-cover dark:invert [background-image:var(--icon-theme-dark)] dark:[background-image:var(--icon-theme-light)]"
        ></button>
        <button type="button" title="Search" accesskey="/"
          onclick="window.linkita.toggleSearch();"
          class="btn-search ml-4 h-6 w-6 shrink-0 cursor-pointer text-[0] bg-center bg-no-repeat bg-cover [background-image:var(--icon-search)] dark:invert"
        ></button>
        <script>window.linkita.initSearchButton({ scripts: ["https://blog.moxuetianya.com/elasticlunr.min.js", "https://blog.moxuetianya.com/search_index.en.js"] });</script>
      </div>
    </div>
  </div>
</header>

  <!-- Begin Body Start inject -->
  
  <!-- End Body Start inject -->
  <main class="prose prose-neutral relative mx-auto min-h-[calc(100%-4rem)]
    max-w-3xl break-words px-4 pb-12 pt-28 lg:pt-32 dark:prose-invert prose-pre:rounded-lg prose-img:rounded-lg">
      <!-- Search -->
<div id="linkita-search-wrapper" class="hidden">
  <ul id="linkita-search-results"></ul>
</div>

    
<article>
  <!-- Begin Page Start inject -->
  
  <!-- End Page Start inject -->

  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">uefi 安装启动</h1>
    <!-- Page Info -->
<div class="text-sm antialiased opacity-80"><time
      datetime="2025-11-28T17:37:06+08:00">2025-11-28</time><span
        class="mx-1">&middot;</span><time
    datetime="PT0H5M0S">5&nbsp;min</time>
</div>

  </header>
  <!-- TOC -->
<div class="block-bg mb-12 rounded-lg p-2 text-lg">
  <details>
    <summary class="select-none py-0.5 lg:py-1 pl-4" accesskey="=">
      <span class="cursor-pointer">Table of Contents</span>
    </summary>
    <div class="px-2">
      <ul>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/uefi 安装启动/#secure-boot-de-qian-ming-lian-pk-kek-db-zhong-de-ge-zi-de-zuo-yong">Secure Boot 的签名链（PK&#x2F;KEK&#x2F;DB） 中的各自的作用？</a>
        </li>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/uefi 安装启动/#xin-ren-lian-de-gen-yuan-oem-gu-jian">信任链的根源 (OEM&#x2F;固件)</a>
          <ul>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/uefi 安装启动/#wei-ruan-de-jiao-se-shang-ye-gong-si-de-dai-li-qian-ming">微软的角色：商业公司的“代理签名”</a>
            </li>
          </ul>
        </li>
        <li>
          <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/uefi 安装启动/#zi-ji-qian-ming-secure-boot-de-shi-ji-liu-cheng-wan-zheng-bu-zou">自己签名 Secure Boot 的实际流程（完整步骤）</a>
          <ul>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/uefi 安装启动/#1-sheng-cheng-san-tao-mi-yao-pk-kek-db">① 生成三套密钥（PK&#x2F;KEK&#x2F;DB）</a>
            </li>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/uefi 安装启动/#2-sheng-cheng-uefi-ke-shi-bie-de-auth-wen-jian">② 生成 UEFI 可识别的 .auth 文件</a>
            </li>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/uefi 安装启动/#3-jin-ru-bios-qie-huan-dao-custom-secure-boot">③ 进入 BIOS，切换到 Custom Secure Boot</a>
            </li>
            <li>
              <a class="no-underline hover:underline" href="https://blog.moxuetianya.com/2025/11/uefi 安装启动/#4-shi-yong-ni-de-db-si-yao-qian-ming-yin-dao-cheng-xu">④ 使用你的 DB 私钥签名引导程序</a>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </details>
</div>

  <!-- Content -->
  <section><h1 id="secure-boot-de-qian-ming-lian-pk-kek-db-zhong-de-ge-zi-de-zuo-yong">Secure Boot 的签名链（PK/KEK/DB） 中的各自的作用？</h1>
<p>结合完整的 Secure Boot 启动链（shim → grub → kernel） 进行详细的解释</p>
<h1 id="xin-ren-lian-de-gen-yuan-oem-gu-jian">信任链的根源 (OEM/固件)</h1>
<ul>
<li>
<p>首先，UEFI 安全启动的信任链始于固件（BIOS/UEFI）。固件中预先存储了三个关键的密钥数据库：</p>
</li>
<li>
<p>平台密钥 (PK - Platform Key): 最高级的密钥，用于签署 KEK 的更新。由 PC 制造商 (OEM) 负责管理。</p>
</li>
<li>
<p>密钥交换密钥 (KEK - Key Exchange Key): 用于签署签名数据库 (db) 和禁止签名数据库 (dbx) 的更新。</p>
</li>
<li>
<p>签名数据库 (db - Signature Database): 包含了被允许执行的操作系统引导加载程序、驱动程序等组件的公钥或证书。</p>
</li>
<li>
<p>初始状态下，这个 db 数据库中通常包含：</p>
</li>
<li>
<p>OEM 自己的证书： 用于验证固件更新和 OEM 自己的工具。</p>
</li>
<li>
<p>Microsoft Corporation UEFI CA 证书： 允许启动所有由微软签名的组件，包括 Windows 启动管理器以及由微软服务签名的第三方引导加载程序。</p>
</li>
</ul>
<p>UEFI 固件内部存有四类关键数据库：</p>
<table><thead><tr><th>名称</th><th>类型</th><th>主要作用</th><th>由谁管理</th></tr></thead><tbody>
<tr><td>PK（Platform Key）</td><td>公开证书 + 私钥在厂商手上</td><td>管理平台最顶层权限（用来更新 KEK）</td><td>OEM（华硕、联想等）</td></tr>
<tr><td>KEK（Key Exchange Key）</td><td>公开证书</td><td>用来更新 DB / DBX</td><td>OEM、Microsoft</td></tr>
<tr><td>DB（Allowed Signatures）允许列表</td><td>证书 + Hash</td><td>允许启动的 EFI 程序的签名</td><td>Microsoft（多数 PC），OEM，用户</td></tr>
<tr><td>DBX（Forbidden Signatures）禁止列表</td><td>证书 + Hash</td><td>被吊销/恶意的 EFI 程序摘要</td><td>Microsoft</td></tr>
</tbody></table>
<p>Secure Boot 的工作原则：UEFI 只允许 DB 中签名的文件启动，禁止 DBX 中的文件。</p>
<ol>
<li>UEFI 会从 DB/DBX 中取证书来验证 shim 的签名</li>
<li>shim.efi 验证 grubx64.efi（第二级验证）
<ul>
<li>shim 内置了一个 shim-own certificate (MOK)
<ul>
<li>→ 是从 Linux 发行版（或用户）生成的</li>
<li>→ 不需要微软参与</li>
</ul>
</li>
<li>所以 shim 的验证过程：
<ul>
<li>shim 内的 MOK 列表（Machine Owner Keys）
↓ 验证 grub 是否被 MOK 签名
grub 才能启动</li>
</ul>
</li>
<li>shim 的最大用途：让 Linux 自己管理信任链，而不依赖微软。</li>
<li>用户也可以加入自己的 MOK（mokutil --import）这样用户可以签：
<ul>
<li>grub</li>
<li>kernel</li>
<li>initrd</li>
<li>甚至自己写的 EFI 程序</li>
</ul>
</li>
</ul>
</li>
<li>grubx64.efi 验证 Linux kernel（第三级验证）
<ul>
<li>使用 shim 提供的验证接口（shim_lock）
<ul>
<li>↓ 验证 kernel 是否被 MOK（DB）签名</li>
<li>kernel 才能加载</li>
</ul>
</li>
</ul>
</li>
<li>通常：
<ul>
<li>在 Ubuntu / Debian，kernel 已经用 Canonical 的私钥签名（内置在 shim MOK 内）</li>
<li>在 Fedora，kernel 用 Red Hat 的私钥签名</li>
<li>所以 grub加载内核时会调用 shim 的验证函数：</li>
<li>verify_pe_signature()</li>
<li>决定内核是否可信。</li>
</ul>
</li>
</ol>
<h2 id="wei-ruan-de-jiao-se-shang-ye-gong-si-de-dai-li-qian-ming">微软的角色：商业公司的“代理签名”</h2>
<ul>
<li>微软确实在为其他商业公司签名方面扮演了核心角色，但不是直接负责。</li>
<li>机制： 微软提供了一个 UEFI CA (Certificate Authority) 证书，这个证书被全球几乎所有 OEM 预装在了 UEFI 固件的 db 数据库中。</li>
<li>服务： 许多第三方操作系统供应商或硬件/驱动程序制造商（如主流的 Linux 发行版，如 Canonical/Ubuntu、Red Hat 等）为了让他们的启动文件能在一台开启了安全启动的 Windows 电脑上运行，会向微软的 硬件仪表板（Hardware Dashboard） 提交他们的启动文件（例如 Linux 的 shim.efi）。</li>
<li>签名： 微软使用自己的 Microsoft UEFI CA 证书的私钥，为这些第三方文件进行数字签名。</li>
<li>结果： 固件检查启动文件时，发现它是由 Microsoft UEFI CA 签名的，而这个 CA 证书在 db 数据库中是被信任的，因此允许启动。</li>
</ul>
<h1 id="zi-ji-qian-ming-secure-boot-de-shi-ji-liu-cheng-wan-zheng-bu-zou">自己签名 Secure Boot 的实际流程（完整步骤）</h1>
<p>下面是 Linux 下常见的方式（OpenSSL + sbsigntools）：</p>
<h2 id="1-sheng-cheng-san-tao-mi-yao-pk-kek-db">① 生成三套密钥（PK/KEK/DB）</h2>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">openssl</span><span> req</span><span style="color:#bf616a;"> -new -x509 -newkey</span><span> rsa:2048</span><span style="color:#bf616a;"> -sha256 -keyout</span><span> PK.key</span><span style="color:#bf616a;"> -out</span><span> PK.crt</span><span style="color:#bf616a;"> -subj </span><span>&quot;</span><span style="color:#a3be8c;">/CN=Custom PK/</span><span>&quot;</span><span style="color:#bf616a;"> -days</span><span> 3650
</span><span style="color:#bf616a;">openssl</span><span> req</span><span style="color:#bf616a;"> -new -x509 -newkey</span><span> rsa:2048</span><span style="color:#bf616a;"> -sha256 -keyout</span><span> KEK.key</span><span style="color:#bf616a;"> -out</span><span> KEK.crt</span><span style="color:#bf616a;"> -subj </span><span>&quot;</span><span style="color:#a3be8c;">/CN=Custom KEK/</span><span>&quot;</span><span style="color:#bf616a;"> -days</span><span> 3650
</span><span style="color:#bf616a;">openssl</span><span> req</span><span style="color:#bf616a;"> -new -x509 -newkey</span><span> rsa:2048</span><span style="color:#bf616a;"> -sha256 -keyout</span><span> DB.key</span><span style="color:#bf616a;"> -out</span><span> DB.crt</span><span style="color:#bf616a;"> -subj </span><span>&quot;</span><span style="color:#a3be8c;">/CN=Custom DB/</span><span>&quot;</span><span style="color:#bf616a;"> -days</span><span> 3650
</span></code></pre>
<h2 id="2-sheng-cheng-uefi-ke-shi-bie-de-auth-wen-jian">② 生成 UEFI 可识别的 .auth 文件</h2>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">cert-to-efi-sig-list -g </span><span>&quot;$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">uuidgen</span><span style="color:#a3be8c;">)</span><span>&quot; PK.crt PK.esl
</span><span style="color:#bf616a;">sign-efi-sig-list -k</span><span> PK.key</span><span style="color:#bf616a;"> -c</span><span> PK.crt PK PK.esl PK.auth
</span></code></pre>
<p>KEK/DB 同理。</p>
<h2 id="3-jin-ru-bios-qie-huan-dao-custom-secure-boot">③ 进入 BIOS，切换到 Custom Secure Boot</h2>
<pre data-lang="text" style="background-color:#2b303b;color:#c0c5ce;" class="language-text "><code class="language-text" data-lang="text"><span>大多数设备 BIOS 中选择：
</span><span>Secure Boot → Custom Mode
</span><span>然后可以导入你的 PK.auth, KEK.auth, DB.auth
</span></code></pre>
<h2 id="4-shi-yong-ni-de-db-si-yao-qian-ming-yin-dao-cheng-xu">④ 使用你的 DB 私钥签名引导程序</h2>
<pre data-lang="text" style="background-color:#2b303b;color:#c0c5ce;" class="language-text "><code class="language-text" data-lang="text"><span>例如对 GRUB2 EFI 文件签名：
</span><span>sbsign --key DB.key --cert DB.crt --output grubx64.efi grubx64.efi
</span><span>然后用这个签名过的 grubx64.efi 启动即可。
</span></code></pre>
</section>
  <hr />
  <!-- Post Taxonomies -->
<footer class="mt-12 flex flex-col" tabindex="-1" accesskey="_">
  <div class="mb-2 flex flex-wrap">
    <span class="block-bg mb-1.5 mr-1.5 rounded-lg px-5 py-1.5">Tags</span>
    
    <a
      class="block-bg block-hover mb-1.5 mr-1.5 rounded-lg px-5 py-1.5 no-underline"
      href="https://blog.moxuetianya.com/tags/uefi/">uefi</a>
    
    <a
      class="block-bg block-hover mb-1.5 mr-1.5 rounded-lg px-5 py-1.5 no-underline"
      href="https://blog.moxuetianya.com/tags/secure-boot/">secure boot</a>
    
  </div>
</footer>

  <!-- Post Nav -->
<nav class="block-bg mt-12 flex flex-wrap rounded-lg text-lg">
  <a
    class="block-hover-mask flex min-w-[50%] grow items-center rounded-l-md p-6 pr-3 font-semibold no-underline"
    href="https://blog.moxuetianya.com/2025/12/默认路由到旁路由/" accesskey=","
    ><span class="mr-1.5">&#8249;</span><span>默认路由到旁路由</span></a>
  <a
    class="block-hover-mask ml-auto flex min-w-[50%] grow items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline"
    href="https://blog.moxuetianya.com/2025/11/为什么ssh长时间空闲后，终端就卡死了/" accesskey="."
    ><span>为什么ssh长时间空闲后，终端就卡死了</span><span class="ml-1.5">&#8250;</span></a>
</nav>

  <!-- Begin Page End inject -->
  
  <!-- End Page End inject -->
</article>

  </main>
  <!-- Footer -->
<footer class="mx-auto flex lg:mt-5 max-w-3xl flex-wrap items-center px-4 py-3 text-sm opacity-60">
  <div class="mr-auto basis-full lg:basis-1/2">
  © <time datetime="2025">2025</time> moxuetianya
  </div>
  <div class="flex basis-full lg:basis-1/2 lg:justify-end">
    <span class="mr-6 lg:ml-6">
      <a class="link" href="https://www.getzola.org/" target="_blank">Powered by Zola</a>
    </span>
    <a class="link" href="https://www.getzola.org/themes/linkita/" target="_blank">&#9998; Linkita</a>
  </div>
  <!-- Begin Footer inject -->
  
  <!-- End Footer inject -->
</footer>

  

  <!-- Begin Body End inject -->
  
  <!-- End Body End inject -->
</body>

</html>
